{% extends 'base_admin.html' %}

{% block title %}Confirmar Exclusão - Grupo {{ grupo.name }}{% endblock %}

{% block extra_css %}
<style>
  /* ========================================
     PAGE LAYOUT
     ======================================== */
  .delete-group-page {
    min-height: calc(100vh - 140px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  }
  
  .delete-group-container {
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
  }
  
  /* ========================================
     BREADCRUMB NAVIGATION
     ======================================== */
  .breadcrumb-nav {
    background: #ffffff;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  
  .breadcrumb-list {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    margin: 0;
    padding: 0;
    font-size: 0.9375rem;
    flex-wrap: wrap;
  }
  
  .breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .breadcrumb-link {
    color: #6b7280;
    text-decoration: none;
    transition: color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }
  
  .breadcrumb-link:hover {
    color: #111827;
  }
  
  .breadcrumb-link svg {
    flex-shrink: 0;
  }
  
  .breadcrumb-separator {
    color: #d1d5db;
    user-select: none;
  }
  
  .breadcrumb-current {
    color: #dc2626;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }
  
  /* ========================================
     GROUP INFO HEADER
     ======================================== */
  .group-info-header {
    background: #ffffff;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border-left: 4px solid #dc2626;
  }
  
  .group-header-content {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }
  
  .group-icon {
    flex-shrink: 0;
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #dc2626;
  }
  
  .group-details {
    flex: 1;
    min-width: 0;
  }
  
  .group-label {
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #6b7280;
    margin-bottom: 0.375rem;
  }
  
  .group-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 0.5rem;
    word-break: break-word;
  }
  
  .group-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    color: #6b7280;
  }
  
  .group-meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }
  
  .group-meta-item svg {
    flex-shrink: 0;
    color: #9ca3af;
  }
  
  /* ========================================
     MAIN CARD WRAPPER
     ======================================== */
  .delete-card-wrapper {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
    overflow: hidden;
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* ========================================
     RESPONSIVE DESIGN
     ======================================== */
  @media (max-width: 767.98px) {
    .delete-group-page {
      padding: 1.5rem 0.75rem;
    }
    
    .breadcrumb-nav {
      padding: 0.875rem 1rem;
      margin-bottom: 1rem;
    }
    
    .breadcrumb-list {
      font-size: 0.875rem;
    }
    
    .group-info-header {
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    
    .group-icon {
      width: 48px;
      height: 48px;
    }
    
    .group-name {
      font-size: 1.25rem;
    }
    
    .group-meta {
      gap: 0.75rem;
    }
  }
  
  @media (max-width: 575.98px) {
    .group-header-content {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .group-details {
      width: 100%;
    }
    
    .group-meta {
      justify-content: center;
    }
  }
  
  /* ========================================
     ACCESSIBILITY
     ======================================== */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
  
  /* Keyboard Focus Styles */
  .breadcrumb-link:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
    border-radius: 4px;
  }
</style>
{% endblock %}

{% block content %}
<div class="delete-group-page">
  <div class="delete-group-container">
    
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav" aria-label="Navegação estrutural">
      <ol class="breadcrumb-list">
        <li class="breadcrumb-item">
          <a href="{% url 'admin:index' %}" class="breadcrumb-link">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            Administração
          </a>
        </li>
        
        <li class="breadcrumb-separator" aria-hidden="true">›</li>
        
        <li class="breadcrumb-item">
          <a href="{% url 'admin:auth_group_changelist' %}" class="breadcrumb-link">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Grupos
          </a>
        </li>
        
        <li class="breadcrumb-separator" aria-hidden="true">›</li>
        
        <li class="breadcrumb-item">
          <span class="breadcrumb-current">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Confirmar Exclusão
          </span>
        </li>
      </ol>
    </nav>
    
    <!-- Group Information Header -->
    <div class="group-info-header">
      <div class="group-header-content">
        <div class="group-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        
        <div class="group-details">
          <div class="group-label">Grupo de Permissões</div>
          <h1 class="group-name">{{ grupo.name }}</h1>
          
          <div class="group-meta">
            {% if grupo.permissions.count %}
            <div class="group-meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              <span>{{ grupo.permissions.count }} permiss{{ grupo.permissions.count|pluralize:"ão,ões" }}</span>
            </div>
            {% endif %}
            
            {% if grupo.user_set.count %}
            <div class="group-meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/>
                <line x1="23" y1="11" x2="17" y2="11"/>
              </svg>
              <span>{{ grupo.user_set.count }} usuário{{ grupo.user_set.count|pluralize }}</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Delete Confirmation Card -->
    <div class="delete-card-wrapper">
      {% include 'documentos/includes/confirm_delete_card.html' with action_url=delete_action_url cancel_url=cancel_url %}
    </div>
    
    <!-- Server-rendered content for JS (avoids embedding Django tags inside JS strings) -->
    <div id="confirmMessageServer" style="display:none;">
      Tem certeza que deseja excluir permanentemente o grupo
      <strong class="highlight-text">{{ grupo.name }}</strong>?
      {% if grupo.permissions.count %}
      <div class="document-info-row">
        <span class="info-label">Permissões:</span>
        <span class="info-value">{{ grupo.permissions.count }}</span>
      </div>
      {% endif %}

      {% if grupo.user_set.count %}
      <div class="document-info-row">
        <span class="info-label">Usuários:</span>
        <span class="info-value">{{ grupo.user_set.count }}</span>
      </div>
      {% endif %}
    </div>

    {% if grupo.user_set.count > 0 %}
    <div id="warningServer" style="display:none;">
      Todas as informações relacionadas serão permanentemente removidas e não poderão ser recuperadas.
      <br><br>
      <strong>⚠️ Atenção:</strong> Este grupo possui {{ grupo.user_set.count }} usuário{{ grupo.user_set.count|pluralize }} associado{{ grupo.user_set.count|pluralize }}.
      Ao excluir o grupo, os usuários perderão as permissões associadas a ele.
    </div>
    {% endif %}
    
  </div>
</div>

<script>
  (function() {
    'use strict';
    
    // ========================================
    // Double Submit Protection
    // ========================================
    const form = document.getElementById('deleteConfirmationForm') || document.querySelector('.delete-confirmation-form');
    
    if (form) {
      let isSubmitting = false;
      
      form.addEventListener('submit', function(e) {
        if (isSubmitting) {
          e.preventDefault();
          return false;
        }
        
        isSubmitting = true;
        
        // Atualizar botão de exclusão
        const deleteBtn = document.getElementById('confirmDeleteBtn') || 
                         document.getElementById('confirmDeleteBtnInline') ||
                         form.querySelector('.btn-delete-confirm');
        
        if (deleteBtn) {
          deleteBtn.disabled = true;
          deleteBtn.classList.add('loading');
          
          const btnText = deleteBtn.querySelector('span:last-child');
          if (btnText) {
            btnText.textContent = 'Excluindo Grupo...';
          }
        }
        
        // Desabilitar botão cancelar
        const cancelBtn = document.getElementById('cancelDeleteBtn') ||
                         form.querySelector('.btn-cancel');
        
        if (cancelBtn) {
          cancelBtn.style.pointerEvents = 'none';
          cancelBtn.style.opacity = '0.5';
        }
      });
    }
    
    // ========================================
    // Update Delete Confirmation Message
    // ========================================
    window.addEventListener('DOMContentLoaded', function() {
      const messageEl = document.getElementById('confirmDeleteMessage');
      const titleEl = document.getElementById('confirmDocTitle');
      const infoEl = document.getElementById('confirmDocInfo');
      
      if (messageEl) {
        const serverMsg = document.getElementById('confirmMessageServer');
        if (serverMsg) {
          messageEl.innerHTML = serverMsg.innerHTML;
        } else {
          messageEl.textContent = 'Tem certeza que deseja excluir permanentemente o grupo ' + '{{ grupo.name }}' + '?';
        }
      }

      if (titleEl && infoEl) {
        titleEl.textContent = '{{ grupo.name }}';
        
        // Mostrar informações do grupo
        if (infoEl.style.display === 'none') {
          infoEl.style.display = 'block';
        }
        
        // Atualizar tipo
        const typeEl = document.getElementById('confirmDocType');
        if (typeEl) {
          typeEl.textContent = 'Grupo de Permissões';
        }
        
        // Adicionar informações extras se disponível
        const contentEl = infoEl.querySelector('.document-info-content');
          if (contentEl) {
            // If server rendered rows exist, move them into the info container
            const serverMsg = document.getElementById('confirmMessageServer');
            if (serverMsg) {
              const rows = serverMsg.querySelectorAll('.document-info-row');
              rows.forEach(function(r) {
                contentEl.appendChild(r.cloneNode(true));
              });
            }
          }
      }
    });
    
    // ========================================
    // ESC Key Handler
    // ========================================
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        
        const cancelBtn = document.getElementById('cancelDeleteBtn') ||
                         document.querySelector('.btn-cancel');
        
        if (cancelBtn && !form?.classList.contains('loading')) {
          if (cancelBtn.href) {
            window.location.href = cancelBtn.href;
          } else {
            cancelBtn.click();
          }
        }
      }
    });
    
    // ========================================
    // Warning for Groups with Users (rendered on server)
    // ========================================
    const warningServer = document.getElementById('warningServer');
    if (warningServer) {
      const warningText = document.querySelector('.warning-alert-text');
      if (warningText) {
        warningText.innerHTML = warningServer.innerHTML;
      }
    }
    
    // ========================================
    // Prevent Accidental Navigation
    // ========================================
    let isNavigatingAway = false;
    
    window.addEventListener('beforeunload', function(e) {
      if (form && form.classList && form.classList.contains('loading') && !isNavigatingAway) {
        e.preventDefault();
        e.returnValue = 'A exclusão do grupo está em andamento. Deseja realmente sair?';
        return e.returnValue;
      }
    });
    
    // Marcar navegação intencional
    const cancelBtn = document.getElementById('cancelDeleteBtn') ||
                     document.querySelector('.btn-cancel');
    
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        isNavigatingAway = true;
      });
    }
    
  })();
</script>
{% endblock %}