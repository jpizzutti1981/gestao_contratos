{% extends 'base.html' %}

{% block content %}
<style>
  .seguros-wrapper { padding: 2rem 0; }
  .page-header { background: white; border-radius: 20px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
  .page-title { font-size: 1.6rem; font-weight: 800; color: #1e293b; margin: 0; }
  .header-actions .btn { border-radius: 10px; }
  .filter-card { background: white; border-radius: 16px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
  .table-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); overflow: hidden; }
  .status-badge { display: inline-flex; align-items: center; gap: .35rem; padding: .25rem .5rem; border-radius: 999px; font-size: .8rem; }
  .status-vencida { background: #fee2e2; color: #b91c1c; }
  .status-a_vencer { background: #fef3c7; color: #b45309; }
  .status-no_prazo { background: #dcfce7; color: #166534; }
</style>

<div class="seguros-wrapper">
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">üìë Controle de Ap√≥lices de Lojas</h1>
      <div class="header-actions d-flex gap-2">
        <a href="{% url 'seguros_loja_novo' %}" class="btn btn-outline-primary">‚ûï Nova Loja</a>
        <a href="{% url 'seguros_apolice_novo' %}" class="btn btn-primary">‚ûï Nova Ap√≥lice</a>
      </div>
    </div>

    <div class="filter-card">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-12 col-md-5">
          <label class="form-label">Shopping</label>
          <select name="shopping" class="form-select">
            <option value="">Todos</option>
            {% for s in shopping_list %}
              <option value="{{ s.id }}" {% if request.GET.shopping == s.id|stringformat:'s' %}selected{% endif %}>{{ s.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-5">
          <label class="form-label">Tipo de Seguro</label>
          <select name="tipo" class="form-select">
            <option value="">Todos</option>
            <option value="rc" {% if tipo == 'rc' %}selected{% endif %}>Responsabilidade Civil</option>
            <option value="incendio" {% if tipo == 'incendio' %}selected{% endif %}>Inc√™ndio</option>
            <option value="multirisco" {% if tipo == 'multirisco' %}selected{% endif %}>Multirisco</option>
            <option value="danos_eletricos" {% if tipo == 'danos_eletricos' %}selected{% endif %}>Danos El√©tricos</option>
            <option value="alagamento" {% if tipo == 'alagamento' %}selected{% endif %}>Alagamento</option>
            <option value="outros" {% if tipo == 'outros' %}selected{% endif %}>Outros</option>
          </select>
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button class="btn btn-outline-secondary" type="submit">Filtrar</button>
        </div>
      </form>
    </div>

    <div class="table-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Shopping</th>
              <th>Loja</th>
              <th>Tipo</th>
              <th>Seguradora</th>
              <th>N¬∫ Ap√≥lice</th>
              <th>Vig√™ncia</th>
              <th>Status Prazo</th>
              <th>Compliance</th>
            </tr>
          </thead>
          <tbody>
            {% for ap in apolices %}
              <tr>
                <td>{{ ap.loja.shopping.nome }}</td>
                <td>
                  <div class="fw-semibold">{{ ap.loja.codigo_loja }} - {{ ap.loja.nome_fantasia }}</div>
                  <div class="text-muted small">{{ ap.loja.segmento|default:'‚Äî' }}</div>
                </td>
                <td>{{ ap.get_tipo_seguro_display }}</td>
                <td>{{ ap.seguradora }}</td>
                <td>{{ ap.numero_apolice }}</td>
                <td>{{ ap.vigencia_inicio|date:'d/m/Y' }} ‚Äî {{ ap.vigencia_fim|date:'d/m/Y' }}</td>
                {% with sp=ap.status_prazo %}
                  <td>
                    <span class="status-badge status-{{ sp }}">
                      {% if sp == 'vencida' %}‚ùå Vencida{% elif sp == 'a_vencer' %}‚ö†Ô∏è A vencer{% else %}‚úÖ No prazo{% endif %}
                    </span>
                  </td>
                {% endwith %}
                <td>
                  {% if ap.status_compliance == 'aprovada' %}
                    <span class="badge bg-success">Aprovada</span>
                  {% elif ap.status_compliance == 'reprovada' %}
                    <span class="badge bg-danger">Reprovada</span>
                  {% elif ap.status_compliance == 'em_analise' %}
                    <span class="badge bg-warning text-dark">Em an√°lise</span>
                  {% elif ap.status_compliance == 'expirada' %}
                    <span class="badge bg-secondary">Expirada</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Pendente</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">Nenhuma ap√≥lice encontrada.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="p-3 d-flex justify-content-between align-items-center">
        <div class="text-muted small">Total: {{ page_obj.paginator.count }} ap√≥lice(s)</div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&shopping={{ request.GET.shopping }}&tipo={{ request.GET.tipo }}">Anterior</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Anterior</span></li>
            {% endif %}
            <li class="page-item disabled"><span class="page-link">P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&shopping={{ request.GET.shopping }}&tipo={{ request.GET.tipo }}">Pr√≥xima</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Pr√≥xima</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
{% endblock %}